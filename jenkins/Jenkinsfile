pipeline {
    agent any

    environment {
        GIT_PATH = 'C:\\Users\\martin\\AppData\\Local\\Programs\\Git\\bin\\git.exe'
        TOP_LEVEL_ENTITY = 'hcmt_cpld_top'
        TEST_RESULTS_XML = 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\ART_QTMP\\QTMP_VCU\\simulation_results.xml'
        CONVERT_SCRIPT = 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\ART_QTMP\\convert_to_junit_xml.py'
        VIVADO_PATH = 'C:\\Xilinx\\Vivado\\2024.1\\bin'
        SCRIPT_PATH = 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\ART_QTMP\\scripts'
        GCC_PATH = 'C:\\MinGW\\bin'
    }

    stages {
        stage('Create Project') {
            steps {
                script {
                    // Clean workspace and initialize repository steps...
                }
            }
        }

        stage('Run Simulation and Test Results') {
            steps {
                script {
                    echo "Running Vivado simulation and processing results..."

                    // Run the simulation
                    bat """
                    "%VIVADO_PATH%\\vivado" -mode batch -source ${env.SCRIPT_PATH}\\run_simulation.tcl
                    """
        
                    // Check if simulation results XML file exists
                    if (fileExists("${env.TEST_RESULTS_XML}")) {
                        echo "Simulation results XML file found: ${env.TEST_RESULTS_XML}"
                        
                        // Convert the simulation results XML to JUnit XML format
                        echo "Converting simulation results to JUnit XML..."
                        bat "python ${env.CONVERT_SCRIPT} ${env.TEST_RESULTS_XML} ${env.SIM_JUNIT_XML}"
                        
                        // Archive the JUnit XML test results
                        echo "Archiving test results..."
                        archiveArtifacts artifacts: "converted_results.xml", allowEmptyArchive: true
                        
                        // Publish the JUnit XML test results
                        echo "Publishing test results..."
                        junit '**/converted_results.xml'
                    } else {
                        echo "ERROR: Simulation results XML file not found: ${env.TEST_RESULTS_XML}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }

        // Skip remaining stages...
    }

    post {
        always {
            echo 'Cleaning up...'
        }
        success {
            echo 'Tests passed successfully!'
        }
        failure {
            echo 'Tests failed. Please check the logs.'
        }
    }
}
